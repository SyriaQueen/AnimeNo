name: Android CI Build - Optimized

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle
        
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Download ONNX Model
      continue-on-error: true
      run: |
        mkdir -p app/src/main/assets
        # Ø¶Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ Ù‡Ù†Ø§ ÙÙŠ Ø­Ø§Ù„ ØªÙˆÙØ±Ù‡ Ù…Ø³ØªÙ‚Ø¨Ù„Ø§Ù‹
        # wget -O app/src/main/assets/anime_detector.onnx YOUR_MODEL_URL
        
    - name: Build Optimized Debug
      run: ./gradlew assembleDebug --stacktrace --build-cache
      
    - name: Upload Optimized APK
      uses: actions/upload-artifact@v4
      with:
        name: app-debug-optimized-v2
        path: app/build/outputs/apk/debug/*.apk
        retention-days: 30
        
    - name: Get APK Size
      run: |
        ls -lh app/build/outputs/apk/debug/*.apk
        du -h app/build/outputs/apk/debug/*.apk
        
    - name: Create Release
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      continue-on-error: true
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v2.0-debug-${{ github.run_number }}
        name: Optimized Debug v2.0.${{ github.run_number }}
        body: |
          ğŸš€ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ø³Ù‘Ù†Ø© 2.0 (Debug Version)
          
          âœ… Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª:
          - Frame skipping Ø°ÙƒÙŠ
          - NNAPI acceleration
          - Buffer pooling
          - Temporal smoothing
          - Memory optimization
          
          ğŸ“ˆ Ø§Ù„Ø£Ø¯Ø§Ø¡:
          - FPS: 30-50 (+200%)
          - Memory: -50%
          - CPU: -50%
          
          âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø© Ø¨ØµÙŠØºØ© Debug Ù„Ø¶Ù…Ø§Ù† Ø³Ù‡ÙˆÙ„Ø© Ø§Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„ÙÙˆØ±ÙŠ.
        files: app/build/outputs/apk/debug/*.apk
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
